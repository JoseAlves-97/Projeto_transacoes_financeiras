CREATE OR REPLACE TABLE `curso-sql-eba-471019.Projeto_Final.total_transfers` AS
SELECT 
transaction_id,
customer_id,
full_name,
account_id,
amount,
status,
type_transaction,
date_completed,
month

FROM (

--PIXMOVIMENTS
SELECT DISTINCT p.id as transaction_id,
a.customer_id,
CONCAT(c.first_name, " ", c.last_name) as full_name,
p.account_id,
p.pix_amount as amount,
p.status,
p.in_or_out as type_transaction,
DATE(action_timestamp) as date_completed,
EXTRACT(month FROM DATE(action_timestamp)) as month
 FROM `Projeto_Final.pix_movements` p 
 LEFT JOIN `Projeto_Final.accounts` a on p.account_id = a.account_id
 LEFT JOIN `Projeto_Final.customers`c on c.customer_id = a.customer_id
 LEFT JOIN `Projeto_Final.time` t on p.pix_completed_at = t.time_id
 WHERE p.status = 'completed' AND DATE(action_timestamp) BETWEEN '2020-01-01' AND '2020-12-31'

UNION ALL
--TRANSFER_INS
SELECT DISTINCT 
i.id as transaction_id,
a.customer_id,
CONCAT(c.first_name, " ", c.last_name) as full_name,
i.account_id,
i.amount,
i.status,
'transfer_ins' as type_transaction,
DATE(action_timestamp) as date_completed,
EXTRACT(month FROM DATE(action_timestamp)) as month
FROM `Projeto_Final.transfer_ins` i
LEFT JOIN `Projeto_Final.accounts` a on i.account_id = a.account_id
LEFT JOIN `Projeto_Final.customers` c on c.customer_id = a.customer_id
LEFT JOIN `Projeto_Final.time` t on i.transaction_completed_at = t.time_id
WHERE i.status = 'completed' AND date(action_timestamp) BETWEEN '2020-01-01' AND '2020-12-31'

UNION ALL
---TRANSFER_OUT
SELECT DISTINCT 
o.id as transaction_id,
a.customer_id,
CONCAT(c.first_name, " ", c.last_name) as full_name,
o.account_id,
o.amount,
o.status,
'transfer_outs' as type_transaction,
DATE(action_timestamp) as date_completed,
EXTRACT(month FROM DATE(action_timestamp)) as month
FROM `Projeto_Final.transfer_outs` o
LEFT JOIN `Projeto_Final.accounts` a on o.account_id = a.account_id
LEFT JOIN `Projeto_Final.customers` c on c.customer_id = a.customer_id
LEFT JOIN `Projeto_Final.time` t on o.transaction_completed_at = t.time_id
WHERE o.status = 'completed' AND date(action_timestamp) BETWEEN '2020-01-01' AND '2020-12-31' 
)